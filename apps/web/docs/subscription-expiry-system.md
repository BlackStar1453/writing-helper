# è®¢é˜…åˆ°æœŸæ£€æŸ¥ç³»ç»Ÿ

## ğŸ“‹ å½“å‰ç³»ç»Ÿåˆ†æ

### ğŸ” åŸæœ‰æœºåˆ¶çš„é—®é¢˜

ç»è¿‡å…¨é¢æ£€æŸ¥ï¼Œå‘ç°å½“å‰ä»£ç åœ¨å¤„ç†æœˆä»˜å’Œå¹´ä»˜ç”¨æˆ·çš„ä½¿ç”¨åˆ°æœŸæ–¹é¢å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

#### 1. **è¢«åŠ¨ä¾èµ–Stripe Webhook**
- âœ… **æœ‰çš„åŠŸèƒ½**ï¼šé€šè¿‡Stripe webhookå¤„ç†è®¢é˜…çŠ¶æ€å˜åŒ–
- âŒ **ç¼ºå¤±çš„åŠŸèƒ½**ï¼šæ²¡æœ‰ä¸»åŠ¨æ£€æŸ¥è®¢é˜…æ˜¯å¦åˆ°æœŸçš„æœºåˆ¶
- âŒ **é£é™©**ï¼šå¦‚æœwebhookå¤±è´¥æˆ–å»¶è¿Ÿï¼Œç”¨æˆ·çŠ¶æ€å¯èƒ½ä¸å‡†ç¡®

#### 2. **è®¢é˜…çŠ¶æ€å¤„ç†ä¸å®Œæ•´**
- âœ… **å¤„ç†çš„çŠ¶æ€**ï¼š`active`ã€`canceled`ã€`unpaid`
- âŒ **æœªå¤„ç†çš„çŠ¶æ€**ï¼š`past_due`ã€`incomplete`ã€`trialing`ã€`paused`ç­‰
- âŒ **å½±å“**ï¼šç”¨æˆ·å¯èƒ½åœ¨åº”è¯¥åœæ­¢æœåŠ¡æ—¶ç»§ç»­ä½¿ç”¨

#### 3. **Xorpayç”¨æˆ·ç¼ºä¹åˆ°æœŸæœºåˆ¶**
- âœ… **æœ‰çš„åŠŸèƒ½**ï¼šæ”¯ä»˜æˆåŠŸåæ¿€æ´»ç”¨æˆ·
- âŒ **ç¼ºå¤±çš„åŠŸèƒ½**ï¼šæ²¡æœ‰åˆ°æœŸæ£€æŸ¥å’Œè‡ªåŠ¨åœç”¨æœºåˆ¶
- âŒ **é£é™©**ï¼šXorpayç”¨æˆ·ä¸€æ—¦æ¿€æ´»å°±æ°¸ä¹…æœ‰æ•ˆ

#### 4. **å¹´ä»˜ç”¨æˆ·ç‰¹æ®Šæƒ…å†µæœªè€ƒè™‘**
- âœ… **æœ‰çš„åŠŸèƒ½**ï¼šè®°å½•äº†`subscriptionInterval`å­—æ®µ
- âŒ **ç¼ºå¤±çš„åŠŸèƒ½**ï¼šæ²¡æœ‰é’ˆå¯¹å¹´ä»˜ç”¨æˆ·çš„ç‰¹æ®Šåˆ°æœŸæ£€æŸ¥
- âŒ **é£é™©**ï¼šå¹´ä»˜ç”¨æˆ·çš„12ä¸ªæœˆå‘¨æœŸå¯èƒ½æ— æ³•æ­£ç¡®å¤„ç†

## âœ… æ–°çš„å®Œæ•´è§£å†³æ–¹æ¡ˆ

### 1. **å¤šå±‚è®¢é˜…çŠ¶æ€æ£€æŸ¥**

#### Stripeè®¢é˜…çŠ¶æ€å¤„ç†
```typescript
// ç°åœ¨å¤„ç†æ‰€æœ‰Stripeè®¢é˜…çŠ¶æ€
if (status === 'active') {
  // æ¿€æ´»è®¢é˜…
} else if (status === 'canceled' || status === 'unpaid' || status === 'incomplete_expired') {
  // å®Œå…¨åœç”¨
} else if (status === 'past_due' || status === 'incomplete') {
  // ä¿æŒè®¢é˜…ä½†æ ‡è®°é—®é¢˜çŠ¶æ€
} else if (status === 'trialing') {
  // è¯•ç”¨æœŸå¤„ç†
} else if (status === 'paused') {
  // æš‚åœå¤„ç†
}
```

#### ä¸»åŠ¨åˆ°æœŸæ£€æŸ¥
```typescript
// ä»Stripeè·å–å‡†ç¡®çš„åˆ°æœŸæ—¶é—´
const subscription = await stripe.subscriptions.retrieve(subscriptionId);
const expiryDate = new Date(subscription.current_period_end * 1000);
const daysUntilExpiry = Math.ceil((expiryDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));
```

### 2. **æ™ºèƒ½åˆ°æœŸæ£€æŸ¥ç³»ç»Ÿ**

#### æ ¸å¿ƒåŠŸèƒ½
- **å®æ—¶çŠ¶æ€æ£€æŸ¥**ï¼šä»Stripeè·å–æœ€æ–°è®¢é˜…çŠ¶æ€
- **æœ¬åœ°ä¼°ç®—**ï¼šå¯¹Xorpayç”¨æˆ·åŸºäºæœ¬åœ°æ•°æ®ä¼°ç®—åˆ°æœŸæ—¶é—´
- **å¤šçŠ¶æ€æ”¯æŒ**ï¼šå¤„ç†æ‰€æœ‰å¯èƒ½çš„è®¢é˜…çŠ¶æ€
- **å¹´ä»˜ç‰¹æ®Šå¤„ç†**ï¼šæ­£ç¡®å¤„ç†12ä¸ªæœˆçš„è®¢é˜…å‘¨æœŸ

#### æ£€æŸ¥é€»è¾‘
```typescript
export async function checkUserSubscriptionExpiry(userId: string): Promise<SubscriptionExpiryInfo | null> {
  // 1. Lifetimeç”¨æˆ·æ°¸ä¸è¿‡æœŸ
  if (user.subscriptionStatus === 'lifetime') {
    return { isExpired: false, expiryDate: null };
  }

  // 2. Stripeç”¨æˆ·ï¼šä»Stripeè·å–å‡†ç¡®ä¿¡æ¯
  if (user.stripeSubscriptionId) {
    const subscription = await stripe.subscriptions.retrieve(user.stripeSubscriptionId);
    const expiryDate = new Date(subscription.current_period_end * 1000);
    return { expiryDate, isExpired: subscription.status === 'canceled' };
  }

  // 3. Xorpayç”¨æˆ·ï¼šåŸºäºæœ¬åœ°æ•°æ®ä¼°ç®—
  if (user.subscriptionInterval) {
    const intervalDays = user.subscriptionInterval === 'year' ? 365 : 30;
    const estimatedExpiry = new Date(lastReset.getTime() + intervalDays * 24 * 60 * 60 * 1000);
    return { expiryDate: estimatedExpiry, isExpired: estimatedExpiry < now };
  }
}
```

### 3. **è‡ªåŠ¨åŒ–ç®¡ç†ç³»ç»Ÿ**

#### å®šæ—¶ä»»åŠ¡
```bash
# æ¯å¤©å‡Œæ™¨3ç‚¹æ£€æŸ¥è®¢é˜…åˆ°æœŸ
0 3 * * * /path/to/npx tsx /path/to/scripts/check-subscription-expiry.ts
```

#### ç®¡ç†åŠŸèƒ½
- **åŒæ­¥StripeçŠ¶æ€**ï¼šä¸»åŠ¨ä»Stripeè·å–æœ€æ–°çŠ¶æ€
- **æ‰¹é‡å¤„ç†è¿‡æœŸç”¨æˆ·**ï¼šè‡ªåŠ¨åœç”¨è¿‡æœŸç”¨æˆ·
- **åˆ°æœŸæé†’**ï¼šè¯†åˆ«å³å°†åˆ°æœŸçš„ç”¨æˆ·ï¼ˆ7å¤©å†…ï¼‰
- **çŠ¶æ€æŠ¥å‘Š**ï¼šç”Ÿæˆè¯¦ç»†çš„åˆ°æœŸæ£€æŸ¥æŠ¥å‘Š

### 4. **ç®¡ç†å‘˜ç•Œé¢**

#### APIç«¯ç‚¹
- `GET /api/admin/subscription-expiry` - è·å–åˆ°æœŸçŠ¶æ€æ¦‚è§ˆ
- `GET /api/admin/subscription-expiry?action=nearing_expiry` - å³å°†åˆ°æœŸç”¨æˆ·
- `GET /api/admin/subscription-expiry?action=expired` - å·²è¿‡æœŸç”¨æˆ·
- `POST /api/admin/subscription-expiry` - æ‰§è¡Œç®¡ç†æ“ä½œ

#### ç®¡ç†æ“ä½œ
- åŒæ­¥Stripeè®¢é˜…çŠ¶æ€
- æ‰¹é‡å¤„ç†è¿‡æœŸç”¨æˆ·
- æ£€æŸ¥ç‰¹å®šç”¨æˆ·çŠ¶æ€
- ç”Ÿæˆåˆ°æœŸæŠ¥å‘Š

## ğŸ”„ å®Œæ•´çš„ç”¨æˆ·ç”Ÿå‘½å‘¨æœŸ

### æœˆä»˜ç”¨æˆ·
```
è´­ä¹°è®¢é˜… â†’ activeçŠ¶æ€ â†’ æ¯æœˆè‡ªåŠ¨ç»­è´¹ â†’ ä»˜æ¬¾å¤±è´¥ â†’ past_due â†’ æœ€ç»ˆcanceled
```

### å¹´ä»˜ç”¨æˆ·
```
è´­ä¹°å¹´ä»˜ â†’ activeçŠ¶æ€ â†’ æ¯æœˆé‡ç½®é¢åº¦ â†’ 12ä¸ªæœˆåç»­è´¹ â†’ ç»§ç»­äº«å—æœåŠ¡
```

### Lifetimeç”¨æˆ·
```
ä¸€æ¬¡æ€§è´­ä¹° â†’ lifetimeçŠ¶æ€ â†’ æ°¸ä¹…æœ‰æ•ˆ â†’ æ— éœ€åˆ°æœŸæ£€æŸ¥
```

### Xorpayç”¨æˆ·
```
æ”¯ä»˜æˆåŠŸ â†’ activeçŠ¶æ€ â†’ åŸºäºæœ¬åœ°æ•°æ®ä¼°ç®—åˆ°æœŸ â†’ åˆ°æœŸåè‡ªåŠ¨åœç”¨
```

## ğŸ› ï¸ ä½¿ç”¨æ–¹æ³•

### 1. **æ‰‹åŠ¨æ£€æŸ¥è®¢é˜…åˆ°æœŸ**
```bash
# è¿è¡Œå®Œæ•´çš„åˆ°æœŸæ£€æŸ¥
npm run check:expiry

# æ£€æŸ¥ç‰¹å®šç”¨æˆ·
curl -X GET "/api/admin/subscription-expiry?action=check_user&userId=user-id"
```

### 2. **åŒæ­¥StripeçŠ¶æ€**
```bash
# APIè°ƒç”¨
curl -X POST "/api/admin/subscription-expiry" \
  -H "Content-Type: application/json" \
  -d '{"action": "sync_stripe"}'
```

### 3. **å¤„ç†è¿‡æœŸç”¨æˆ·**
```bash
# æ‰¹é‡å¤„ç†è¿‡æœŸç”¨æˆ·
curl -X POST "/api/admin/subscription-expiry" \
  -H "Content-Type: application/json" \
  -d '{"action": "handle_expired"}'
```

### 4. **è®¾ç½®å®šæ—¶ä»»åŠ¡**
```bash
# æ·»åŠ åˆ°crontab
0 3 * * * /path/to/npx tsx /path/to/scripts/check-subscription-expiry.ts
```

## ğŸ“Š ç›‘æ§æŒ‡æ ‡

### å…³é”®æŒ‡æ ‡
- **å³å°†åˆ°æœŸç”¨æˆ·æ•°**ï¼š7å¤©å†…åˆ°æœŸçš„ç”¨æˆ·
- **å·²è¿‡æœŸç”¨æˆ·æ•°**ï¼šè®¢é˜…å·²è¿‡æœŸä½†çŠ¶æ€æœªæ›´æ–°çš„ç”¨æˆ·
- **StripeåŒæ­¥æˆåŠŸç‡**ï¼šStripeçŠ¶æ€åŒæ­¥çš„æˆåŠŸç‡
- **è‡ªåŠ¨å¤„ç†æˆåŠŸç‡**ï¼šè¿‡æœŸç”¨æˆ·è‡ªåŠ¨å¤„ç†çš„æˆåŠŸç‡

### å‘Šè­¦è®¾ç½®
- è¿‡æœŸç”¨æˆ·æ•°é‡è¶…è¿‡é˜ˆå€¼
- StripeåŒæ­¥å¤±è´¥
- å®šæ—¶ä»»åŠ¡æ‰§è¡Œå¤±è´¥
- å¤§é‡ç”¨æˆ·å³å°†åˆ°æœŸ

## ğŸ¯ æ€»ç»“

### âœ… ç°åœ¨å…·å¤‡çš„èƒ½åŠ›
1. **å®Œæ•´çš„çŠ¶æ€å¤„ç†**ï¼šæ”¯æŒæ‰€æœ‰Stripeè®¢é˜…çŠ¶æ€
2. **ä¸»åŠ¨åˆ°æœŸæ£€æŸ¥**ï¼šä¸ä¾èµ–webhookçš„ä¸»åŠ¨æ£€æŸ¥æœºåˆ¶
3. **æ™ºèƒ½ä¼°ç®—**ï¼šå¯¹Xorpayç”¨æˆ·çš„åˆ°æœŸæ—¶é—´ä¼°ç®—
4. **è‡ªåŠ¨åŒ–ç®¡ç†**ï¼šå®šæ—¶ä»»åŠ¡å’Œæ‰¹é‡å¤„ç†
5. **å¹´ä»˜ç‰¹æ®Šå¤„ç†**ï¼šæ­£ç¡®å¤„ç†å¹´ä»˜ç”¨æˆ·çš„12ä¸ªæœˆå‘¨æœŸ
6. **ç®¡ç†å‘˜å·¥å…·**ï¼šå®Œæ•´çš„ç®¡ç†ç•Œé¢å’ŒAPI

### ğŸ”„ æ£€æŸ¥æœºåˆ¶
- **å®æ—¶æ£€æŸ¥**ï¼šæ¯æ¬¡ä½¿ç”¨æ—¶æ£€æŸ¥ç”¨æˆ·çŠ¶æ€
- **å®šæ—¶åŒæ­¥**ï¼šæ¯å¤©åŒæ­¥StripeçŠ¶æ€
- **ä¸»åŠ¨å¤„ç†**ï¼šè‡ªåŠ¨å¤„ç†è¿‡æœŸç”¨æˆ·
- **æå‰é¢„è­¦**ï¼š7å¤©åˆ°æœŸæé†’

ç°åœ¨ç³»ç»Ÿå…·å¤‡äº†å®Œæ•´çš„è®¢é˜…åˆ°æœŸæ£€æŸ¥å’Œå¤„ç†èƒ½åŠ›ï¼Œèƒ½å¤Ÿå‡†ç¡®è¯†åˆ«å’Œå¤„ç†æœˆä»˜ã€å¹´ä»˜ç”¨æˆ·çš„åˆ°æœŸæƒ…å†µï¼ğŸ‰

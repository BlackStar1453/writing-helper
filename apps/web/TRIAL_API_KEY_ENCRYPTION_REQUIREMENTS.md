# 试用API Key加密传输需求文档

## 📋 需求概述

### 问题描述
- 当前试用API Key以明文形式在Deep Link中传输
- 用户可以在客户端配置文件中直接看到API Key
- 存在安全风险，需要避免用户直接看到API Key

### 解决方案
实现简单的加密传输和客户端解密机制，避免明文传输API Key。

## 🎯 功能需求

### 核心需求
1. **服务器端加密**：在生成Deep Link时对试用API Key进行加密
2. **客户端解密**：客户端接收到加密的Key后进行解密
3. **透明使用**：解密后的Key功能完全不变，保持现有业务逻辑

### 非功能需求
1. **简单性**：使用简单的对称加密，避免复杂的密钥管理
2. **兼容性**：保持现有Deep Link格式，只是将明文Key替换为加密Key
3. **无额外调用**：不需要额外的API调用，一次传输完成
4. **轻量级**：加密/解密过程要快速，不影响用户体验

## 🔧 技术需求

### 加密方案
```
加密算法：AES-256-GCM（推荐）或 AES-256-CBC
密钥来源：环境变量中的固定密钥
初始化向量：随机生成，与密文一起传输
输出格式：Base64编码的加密字符串
```

### 数据流程
```
服务器端：
trialApiKey (明文) → 加密 → encryptedTrialKey (Base64) → Deep Link

客户端：
Deep Link → encryptedTrialKey (Base64) → 解密 → trialApiKey (明文) → 使用
```

### 接口变更
```
Deep Link数据结构：
{
  id: string,
  email: string,
  plan: string,
  token: string,
  expiresDate: number,
  syncType: string,
  encryptedTrialKey: string  // 新增：加密的试用Key
  // 移除：trialApiKey (明文)
}
```

## 📝 实现范围

### 需要修改的文件
1. **服务器端**：
   - `lib/user-sync-notification.ts` - Deep Link生成
   - `src/app/api/tauri-auth/initiate/route.ts` - Tauri认证API
   - 新增：`lib/crypto/trial-key-encryption.ts` - 加密工具

2. **客户端指南**：
   - 更新 `CLIENT_INTEGRATION_GUIDE.md`
   - 更新 `CLIENT_QUICK_START.md`

### 不需要修改的部分
- 试用Key的创建、存储、过期逻辑保持不变
- 试用Key的使用方式保持不变
- OpenRouter API调用方式保持不变

## 🧪 测试需求

### 测试用例
1. **加密测试**：验证API Key能正确加密
2. **解密测试**：验证加密的Key能正确解密
3. **端到端测试**：验证完整的加密传输流程
4. **兼容性测试**：验证现有功能不受影响
5. **错误处理测试**：验证解密失败时的处理

### 测试数据
```
测试API Key: "sk-or-v1-test-key-for-encryption-testing"
预期结果: 加密后不等于原文，解密后等于原文
```

## 🔒 安全考虑

### 密钥管理
- 加密密钥存储在服务器环境变量中
- 客户端需要内置相同的解密密钥
- 密钥应该足够复杂，建议32字节随机字符串

### 安全级别
- 防止普通用户直接看到API Key
- 防止网络传输中的明文泄露
- 不防止有技术能力的用户逆向获取Key（符合需求）

## ✅ 验收标准

### 功能验收
1. Deep Link中不再包含明文API Key
2. 客户端能正确解密并使用API Key
3. 所有现有功能正常工作
4. 加密/解密过程对用户透明

### 性能验收
1. 加密/解密时间 < 10ms
2. Deep Link长度增加 < 50%
3. 不影响现有API响应时间

### 安全验收
1. 明文API Key不出现在任何传输数据中
2. 加密Key无法直接识别为API Key格式
3. 每次加密结果不同（使用随机IV）

## 📚 文档需求

### 技术文档
1. 加密/解密算法说明
2. 密钥配置指南
3. 错误处理说明

### 客户端集成文档
1. 解密函数实现示例
2. 错误处理最佳实践
3. 安全注意事项

## 🚀 实施计划

### 阶段1：基础实现
1. 创建加密工具函数
2. 修改服务器端Deep Link生成
3. 创建基础测试

### 阶段2：集成测试
1. 端到端测试
2. 兼容性验证
3. 性能测试

### 阶段3：文档更新
1. 更新客户端集成指南
2. 创建迁移指南
3. 安全最佳实践文档

## 📋 交付物

1. **代码实现**：
   - 加密工具模块
   - 修改后的Deep Link生成逻辑
   - 完整的测试套件

2. **文档更新**：
   - 更新的客户端集成指南
   - 加密/解密实现示例
   - 安全配置说明

3. **测试验证**：
   - 自动化测试脚本
   - 端到端测试报告
   - 性能测试结果

## 🔄 后续维护

### 密钥轮换
- 建议定期更换加密密钥
- 需要协调服务器端和客户端同步更新

### 监控告警
- 监控解密失败率
- 记录异常的解密尝试

### 版本兼容
- 考虑未来可能的加密算法升级
- 保持向后兼容性

# é‡å¤åŒæ­¥é—®é¢˜ä¿®å¤æ–¹æ¡ˆ

## é—®é¢˜æè¿°

åœ¨ hasNotEngine-ultra-fast ä¸­å‘ç°äº†ä½¿ç”¨é‡é‡å¤æ·»åŠ çš„é—®é¢˜ã€‚ç”¨æˆ·å®é™…åªä½¿ç”¨äº†ä¸€æ¬¡ï¼Œä½†æ•°æ®åº“ä¸­çš„ä½¿ç”¨é‡å´å¢åŠ äº†å¤šæ¬¡ï¼ˆå¦‚å¢åŠ äº†3æ¬¡ï¼‰ã€‚

## é—®é¢˜åŸå› åˆ†æ

é€šè¿‡ä»£ç åˆ†æï¼Œå‘ç°äº†ä»¥ä¸‹å¯èƒ½å¯¼è‡´é‡å¤è®¡æ•°çš„é—®é¢˜ï¼š

### 1. å¤šä¸ªåŒæ­¥æœºåˆ¶å¹¶è¡Œè¿è¡Œ
- `ActiveSyncManager` çš„ä¸»åŒæ­¥æ£€æŸ¥ï¼ˆæ¯5åˆ†é’Ÿï¼‰
- `ActiveSyncManager` çš„å¿ƒè·³æ£€æŸ¥ï¼ˆæ¯2åˆ†é’Ÿï¼‰  
- ä¿éšœæœºåˆ¶çš„å¼ºåˆ¶åŒæ­¥ï¼ˆæ¯10åˆ†é’Ÿï¼‰
- æ‰‹åŠ¨è§¦å‘çš„åŒæ­¥

### 2. ç¼“å­˜æ•°æ®ç«æ€æ¡ä»¶
åœ¨é«˜å¹¶å‘æƒ…å†µä¸‹ï¼ŒåŒä¸€ç”¨æˆ·çš„ç¼“å†²åŒºæ•°æ®å¯èƒ½è¢«å¤šä¸ªåŒæ­¥è¿›ç¨‹åŒæ—¶å¤„ç†ã€‚

### 3. æ•°æ®åº“æ›´æ–°ç¼ºä¹åŸå­æ€§
åŸæ¥çš„å®ç°ä½¿ç”¨åˆ†åˆ«çš„ UPDATE è¯­å¥ï¼Œå¯èƒ½å¯¼è‡´éƒ¨åˆ†æ›´æ–°æˆåŠŸè€Œäº§ç”Ÿä¸ä¸€è‡´çŠ¶æ€ã€‚

### 4. ç¼ºä¹åŒæ­¥é”æœºåˆ¶
æ²¡æœ‰é˜²æ­¢ç›¸åŒç¼“å†²åŒºæ•°æ®è¢«é‡å¤åŒæ­¥çš„æœºåˆ¶ã€‚

## ä¿®å¤æ–¹æ¡ˆ

### 1. æ·»åŠ åŒæ­¥é”æœºåˆ¶

```typescript
// åŒæ­¥é”æœºåˆ¶ - é˜²æ­¢åŒä¸€ç”¨æˆ·çš„ç¼“å†²åŒºè¢«é‡å¤åŒæ­¥
const syncLocks = new Map<string, { timestamp: number; bufferSnapshot: string }>();
const SYNC_LOCK_TIMEOUT = 30000; // 30ç§’åŒæ­¥é”è¶…æ—¶
```

- ä¸ºæ¯ä¸ªç”¨æˆ·çš„åŒæ­¥æ“ä½œæ·»åŠ é”
- é”åŒ…å«ç¼“å†²åŒºæ•°æ®å¿«ç…§ï¼Œé˜²æ­¢ç›¸åŒæ•°æ®è¢«é‡å¤åŒæ­¥
- è‡ªåŠ¨è¶…æ—¶æœºåˆ¶é˜²æ­¢æ­»é”

### 2. æ”¹è¿›æ•°æ®åº“åŒæ­¥ä¸ºäº‹åŠ¡æ“ä½œ

```typescript
// ä½¿ç”¨äº‹åŠ¡ç¡®ä¿åŸå­æ€§æ“ä½œï¼Œé˜²æ­¢é‡å¤æ›´æ–°
await db.transaction(async (tx) => {
  // å…ˆè·å–å½“å‰æ•°æ®åº“ä¸­çš„æœ€æ–°å€¼
  const currentUser = await tx.select(...).from(users).where(eq(users.id, userId));
  
  // è®¡ç®—æ–°çš„ä½¿ç”¨é‡å€¼
  const newPremiumUsed = (currentUser.premiumRequestsUsed || 0) + data.premiumBufferUsed;
  const newFastUsed = (currentUser.fastRequestsUsed || 0) + data.fastBufferUsed;
  
  // æ‰§è¡Œå•æ¬¡åŸå­æ›´æ–°
  await tx.update(users).set(updateData).where(eq(users.id, userId));
});
```

### 3. åŒé‡æ£€æŸ¥æœºåˆ¶

åœ¨åŒæ­¥å‰é‡æ–°è·å–æœ€æ–°çš„ç¼“å­˜æ•°æ®ï¼Œç¡®ä¿æ²¡æœ‰å…¶ä»–è¿›ç¨‹å·²ç»å¤„ç†è¿‡ç›¸åŒçš„ç¼“å†²åŒºæ•°æ®ã€‚

### 4. å¢å¼ºçš„è¯·æ±‚å»é‡

ä¿æŒåŸæœ‰çš„5ç§’è¯·æ±‚å»é‡çª—å£ï¼Œé˜²æ­¢çŸ­æ—¶é—´å†…çš„é‡å¤è¯·æ±‚ã€‚

## æ–°å¢åŠŸèƒ½

### 1. è¯Šæ–­å·¥å…·

```typescript
// è¯Šæ–­é‡å¤åŒæ­¥é—®é¢˜
export function diagnoseDuplicateSync(userId: string)

// å¼ºåˆ¶æ¸…ç†ç”¨æˆ·çš„æ‰€æœ‰åŒæ­¥çŠ¶æ€
export function forceClearUserSyncState(userId: string)
```

### 2. ç®¡ç†å‘˜API

æ–°å¢ä»¥ä¸‹ç®¡ç†å‘˜APIç«¯ç‚¹ï¼š

- `diagnose_duplicate_sync`: è¯Šæ–­ç”¨æˆ·çš„åŒæ­¥çŠ¶æ€
- `clear_sync_state`: æ¸…ç†ç”¨æˆ·çš„åŒæ­¥çŠ¶æ€
- `test_duplicate_prevention`: æµ‹è¯•é‡å¤é˜²æŠ¤æœºåˆ¶

### 3. å‰ç«¯è¯Šæ–­é¡µé¢

åˆ›å»ºäº† `/admin/sync-diagnosis` é¡µé¢ï¼Œæä¾›å¯è§†åŒ–çš„è¯Šæ–­å’Œæµ‹è¯•å·¥å…·ã€‚

## ä½¿ç”¨æ–¹æ³•

### 1. è¯Šæ–­ç°æœ‰é—®é¢˜

```bash
# ä½¿ç”¨æµ‹è¯•è„šæœ¬
npx tsx scripts/test-duplicate-sync.ts

# æˆ–è®¿é—®ç®¡ç†å‘˜é¡µé¢
# http://localhost:3000/admin/sync-diagnosis
```

### 2. API è°ƒç”¨ç¤ºä¾‹

```javascript
// è¯Šæ–­ç”¨æˆ·åŒæ­¥çŠ¶æ€
const diagnosis = await fetch('/api/admin/users-usage', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    action: 'diagnose_duplicate_sync',
    userId: 'user-id'
  })
});

// æµ‹è¯•é‡å¤é˜²æŠ¤
const testResult = await fetch('/api/admin/users-usage', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    action: 'test_duplicate_prevention',
    userId: 'user-id',
    testType: 'fast',
    testCount: 5
  })
});
```

### 3. æ¸…ç†é—®é¢˜çŠ¶æ€

å¦‚æœå‘ç°ç”¨æˆ·å­˜åœ¨åŒæ­¥é—®é¢˜ï¼š

```javascript
// æ¸…ç†ç”¨æˆ·åŒæ­¥çŠ¶æ€
await fetch('/api/admin/users-usage', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    action: 'clear_sync_state',
    userId: 'user-id'
  })
});
```

## ç›‘æ§å’Œç»´æŠ¤

### 1. æ—¥å¿—ç›‘æ§

å…³æ³¨ä»¥ä¸‹æ—¥å¿—ä¿¡æ¯ï¼š
- `ğŸ”’ [SmartCache] è®¾ç½®åŒæ­¥é”`
- `âš ï¸ [SmartCache] ç›¸åŒç¼“å†²åŒºæ•°æ®æ­£åœ¨åŒæ­¥ä¸­`
- `âœ… [DB-Sync] äº‹åŠ¡æäº¤æˆåŠŸ`

### 2. å®šæœŸæ£€æŸ¥

- åŒæ­¥é”ä¼šæ¯åˆ†é’Ÿè‡ªåŠ¨æ¸…ç†è¿‡æœŸé”
- å»ºè®®å®šæœŸè¿è¡Œè¯Šæ–­è„šæœ¬æ£€æŸ¥ç³»ç»ŸçŠ¶æ€

### 3. æ€§èƒ½å½±å“

- æ–°å¢çš„é”æœºåˆ¶å’Œäº‹åŠ¡æ“ä½œå¯¹æ€§èƒ½å½±å“å¾ˆå°
- å®é™…ä¸Šé€šè¿‡å‡å°‘é‡å¤æ“ä½œå¯èƒ½ä¼šæå‡æ•´ä½“æ€§èƒ½

## éªŒè¯ä¿®å¤æ•ˆæœ

1. è¿è¡Œæµ‹è¯•è„šæœ¬éªŒè¯å¹¶å‘è¯·æ±‚ä¸ä¼šäº§ç”Ÿé‡å¤è®¡æ•°
2. ä½¿ç”¨ç®¡ç†å‘˜é¡µé¢è¿›è¡Œå®æ—¶è¯Šæ–­
3. ç›‘æ§ç”Ÿäº§ç¯å¢ƒçš„ä½¿ç”¨é‡æ•°æ®æ˜¯å¦å‡†ç¡®

## æ³¨æ„äº‹é¡¹

1. ä¿®å¤åçš„ä»£ç å‘åå…¼å®¹ï¼Œä¸ä¼šå½±å“ç°æœ‰åŠŸèƒ½
2. åŒæ­¥é”æœ‰30ç§’è¶…æ—¶ï¼Œæ­£å¸¸æƒ…å†µä¸‹ä¸ä¼šå½±å“ç”¨æˆ·ä½“éªŒ
3. å¦‚æœå‘ç°å¼‚å¸¸ï¼Œå¯ä»¥ä½¿ç”¨æ¸…ç†åŠŸèƒ½é‡ç½®ç”¨æˆ·çŠ¶æ€
